version: '3'
services:

  mysql:
    image: mysql:5.7
    command: mysqld --character-set-server=utf8
      --collation-server=utf8_unicode_ci --init-connect='SET NAMES UTF8;'
      --innodb-flush-log-at-trx-commit=0 --bind-address=0.0.0.0
    environment:
      - MYSQL_ROOT_PASSWORD=lemon
    volumes:
      - ./extras/initdb.d:/docker-entrypoint-initdb.d
      - /srv/lemonade/mysql-dev:/var/lib/mysql
    networks:
      local:
        aliases: [lemonade_db, db]
    restart: on-failure
    ports:
    - 33062:3306
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  redis:
    image: redis:4
    networks:
      - local
    restart: on-failure
    ports:
    - 36379:6379
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping | grep PONG"]
      interval: 1s
      timeout: 3s
      retries: 5

  thorn:
    build: ./thorn
    image: eubrabigsea/thorn:2.4.0
    volumes:
      - ./config/thorn-config.yaml:/usr/local/thorn/conf/thorn-config.yaml
    networks:
      - local
    restart: always
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy

  thorn_worker:
    build: ./thorn
    image: eubrabigsea/thorn:2.4.0
    entrypoint:
      - "/usr/bin/dumb-init"
      - "--"
      - "/usr/local/bin/entrypoint"
      - "worker"
    volumes:
      - ./config/thorn-config.yaml:/usr/local/thorn/conf/thorn-config.yaml
    networks:
      - local
    restart: always
    depends_on:
      thorn:
        condition: service_started

  limonero:
    build: ./limonero
    image: eubrabigsea/limonero:2.4.0
    environment:
      - HADOOP_USER_NAME=hadoop
    volumes:
      - ./config/limonero-config.yaml:/usr/local/limonero/conf/limonero-config.yaml
      - /srv/lemonade/storage:/srv/storage
    networks:
      - local
    restart: always
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy

  stand:
    build: ./stand
    image: eubrabigsea/stand:2.4.0
    volumes:
      - ./config/stand-config.yaml:/usr/local/stand/conf/stand-config.yaml
    networks:
      - local
    restart: always
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy

  stand_worker:
    build: ./stand
    image: eubrabigsea/stand:2.4.0
    working_dir: /usr/local/stand/
    entrypoint: 
      - "/usr/local/bin/python"
      - "stand/scheduler/scheduler.py"
    volumes:
      - ./config/stand-config.yaml:/usr/local/stand/conf/stand-config.yaml
    networks:
      - local
    environment:
      - PYTHONPATH=.:/usr/local/stand/
    restart: always
    depends_on:
      mysql:
        condition: service_started

  caipirinha:
    build: ./caipirinha
    image: eubrabigsea/caipirinha:2.4.0
    volumes:
      - ./config/caipirinha-config.yaml:/usr/local/caipirinha/conf/caipirinha-config.yaml
    networks:
      - local
    restart: always
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy

  tahiti:
    build: ./tahiti
    image: eubrabigsea/tahiti:2.4.0
    volumes:
      - ./config/tahiti-config.yaml:/usr/local/tahiti/conf/tahiti-config.yaml
    networks:
      - local
    restart: always
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy

  juicer:
    build: ./juicer
    image: eubrabigsea/juicer:2.4.0
    environment:
      - HADOOP_USER_NAME=hadoop
      - PYSPARK_PYTHON=python3
    command: ["/usr/local/juicer/sbin/juicer-daemon.sh", "docker"]
    volumes:
      - ./config/juicer-config.yaml:/usr/local/juicer/conf/juicer-config.yaml
      - ./config/hdfs-site.xml:/opt/hadoop/etc/hadoop/hdfs-site.xml
      - /srv/lemonade/storage:/srv/storage
      - ./lemonade-spark-ext/target/lemonade-spark-ext-1.0-SNAPSHOT.jar:/usr/local/juicer/jars/lemonade-spark-ext-1.0-SNAPSHOT.jar
      - ./spark-fairness/target/spark-fairness_2.11-1.0.jar:/usr/local/juicer/jars/spark-fairness_2.11-1.0.jar
      - ./spark-2.4.5-bin-without-hadoop:/opt/spark-2.4.5-bin-without-hadoop/
      - ./spark-3.4.2-bin-without-hadoop:/opt/spark-3.4.2-bin-without-hadoop/
    networks:
      - local
    restart: always
    # Uncomment next lines if you are connecting to an external spark cluster
    ports:
      - '4000-4050:4000-4050'
      - '35000-35200:35000-35200'
    stop_grace_period: 1s
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
   # network_mode: "host"

  juicer_worker:
    build: ./juicer
    image: eubrabigsea/juicer:2.4.0
    entrypoint:
      - "rq"
      - "worker"
      - "-v"
      - "--url"
      - "redis://redis"
      - "juicer"
    volumes:
      - ./config/juicer-config.yaml:/usr/local/juicer/conf/juicer-config.yaml
    networks:
      - local
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: always

  citrus:
    build: ./citrus
    image: eubrabigsea/citrus:2.4.0
    ports:
      - '23456:8080'
    volumes:
      - ./config/nginx.conf:/etc/nginx/conf.d/default.conf
    networks:
      - local
    restart: always
    depends_on:
      thorn:
        condition: service_started
      tahiti:
        condition: service_started
      limonero:
        condition: service_started
      caipirinha:
        condition: service_started

#   seed:
#     build: ./seed
#     image: eubrabigsea/seed:2.4.0
#     volumes:
#       - ./config/seed-config.yaml:/usr/local/seed/conf/seed-config.yaml
#     networks:
#       - local
#     restart: always
#
#   seed_worker:
#     build: ./seed
#     image: eubrabigsea/seed:2.4.0
#     entrypoint:
#       - "/usr/bin/dumb-init"
#       - "--"
#       - "/usr/local/bin/entrypoint"
#       - "worker"
#     volumes:
#       - ./config/seed-config.yaml:/usr/local/seed/conf/seed-config.yaml
#     networks:
#       - local
#     restart: always

networks:
  local:
    enable_ipv6: false
